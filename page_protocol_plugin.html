<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>cc_tools_qt: Developing Custom Protocol Plugin</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">cc_tools_qt
   </div>
   <div id="projectbrief">Common Environment for Protocol Analysis.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Developing Custom Protocol Plugin</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#page_protocol_plugin_protocol_def">Protocol Definition</a></li>
<li class="level1"><a href="#page_protocol_plugin_message">Messages in Plugin Environment</a></li>
<li class="level1"><a href="#page_protocol_plugin_fields_properties">Fields and Their Properties</a></li>
<li class="level1"><a href="#page_protocol_plugin_all_messages">All Messages</a></li>
<li class="level1"><a href="#page_protocol_plugin_stack">Protocol Stack</a></li>
<li class="level1"><a href="#page_protocol_plugin_transport_message">Transport Message</a></li>
<li class="level1"><a href="#page_protocol_plugin_protocol">Protocol Class</a></li>
<li class="level1"><a href="#page_protocol_plugin_plugin_class">Plugin Class</a></li>
</ul>
</div>
<div class="textblock"><p>Developing the <b>protocol</b> plugins is significantly more complex than developing the <b>socket</b> or <b>filter</b> ones. Please follow this tutorial, while observing the implementation of the <b>Demo Protocol</b> (the sources are <a href="https://github.com/commschamp/cc_tools_qt/tree/master/demo">here</a>) provided as part of the <a href="https://github.com/commschamp/cc_tools_qt">CommsChampion Tools Project</a>.</p>
<h1><a class="anchor" id="page_protocol_plugin_protocol_def"></a>
Protocol Definition</h1>
<p>The protocol messages as well as wrapping transport information need to be implemented using <a href="https://github.com/commschamp/comms">COMMS Library</a> in a certain generic way, which will allow it to be compiled and used in any application, whether it is bare-metal platform with limited resouces or <b>protocol</b> plugin for <a href="https://github.com/commschamp/cc_tools_qt">CommsChampion Tools</a>.</p>
<p>First of all, the common message interface class needs to inherit from or be alias to <b>comms::Message</b> class, while providing only endian and type of ID information as options. It must also provide variadic template parameter to allow extension of the interface with more options. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span>... TOptions&gt;</div>
<div class="line"><span class="keyword">using </span>DemoMessage =</div>
<div class="line">    comms::Message&lt;</div>
<div class="line">        comms::option::BigEndian,</div>
<div class="line">        comms::option::MsgIdType&lt;MsgId&gt;, <span class="comment">// MsgId is enum with numeric message IDs</span></div>
<div class="line">        TOptions...</div>
<div class="line">    &gt;;</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// namespace demo</span></div>
</div><!-- fragment --><p> Such definition leaves room for the application to define the required polymorphic interface as well as choose iterators for read/write operations.</p>
<p>All the actual message definition classes are expected to receive their interface class as a template parameter. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TMsgBase&gt;</div>
<div class="line"><span class="keyword">class </span>IntValues : <span class="keyword">public</span></div>
<div class="line">    comms::MessageBase&lt;</div>
<div class="line">        TMsgBase,</div>
<div class="line">        comms::option::StaticNumIdImpl&lt;MsgId_IntValues&gt;,</div>
<div class="line">        comms::option::FieldsImpl&lt;IntValuesFields::All&gt;,</div>
<div class="line">        comms::option::MsgType&lt;IntValues&lt;TMsgBase&gt; &gt;</div>
<div class="line">    &gt;</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// namespace demo</span></div>
</div><!-- fragment --><p> <b>NOTE</b>, that the message definition class inherits from <b>comms::MessageBase</b>, which will inherit from provided <b>TMsgBase</b> template parameter. The provided template parameter must be alias to, or inherit (directly or indirectly) from <b>comms::Message</b>.</p>
<p>When defining transport layers, allow selection of the common interface class as well as input messages as template parameters (see <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/include/demo/Stack.h">Stack.h</a> as an example). </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> TMsgBase, <span class="keyword">typename</span> TMessages, ...&gt;</div>
<div class="line"><span class="keyword">using </span>Stack = ...;</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// namespace demo</span></div>
</div><!-- fragment --><h1><a class="anchor" id="page_protocol_plugin_message"></a>
Messages in Plugin Environment</h1>
<p>When developing plugin for <b>CommsChampion Tools</b>, there is a need to define separate message interface class, which inherits from <a class="el" href="classcc__tools__qt_1_1MessageBase.html" title="Helper class used to define protocol message interface class in CommsChampion Tools plugin environmen...">cc_tools_qt::MessageBase</a> and provides the defined earlier interface class as its template parameter. See <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/cc_plugin/DemoMessage.h">cc_plugin/DemoMessage.h</a> as an example. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>cc_plugin</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>DemoMessage : <span class="keyword">public</span> <a class="code hl_class" href="classcc__tools__qt_1_1MessageBase.html">cc_tools_qt::MessageBase</a>&lt;demo::DemoMessage&gt;</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace cc_plugin</span></div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace demo</span></div>
<div class="ttc" id="aclasscc__tools__qt_1_1MessageBase_html"><div class="ttname"><a href="classcc__tools__qt_1_1MessageBase.html">cc_tools_qt::MessageBase</a></div><div class="ttdoc">Helper class used to define protocol message interface class in CommsChampion Tools plugin environmen...</div><div class="ttdef"><b>Definition</b> MessageBase.h:62</div></div>
</div><!-- fragment --><p> Please note, that the first template parameter of <a class="el" href="classcc__tools__qt_1_1MessageBase.html" title="Helper class used to define protocol message interface class in CommsChampion Tools plugin environmen...">cc_tools_qt::MessageBase</a> is a "template template" one, and the common interface class name defined earlier (<b>demo::DemoMessage</b>) is passed to it "as-is" without angle brackets.</p>
<p>The <a class="el" href="classcc__tools__qt_1_1MessageBase.html" title="Helper class used to define protocol message interface class in CommsChampion Tools plugin environmen...">cc_tools_qt::MessageBase</a> uses multiple inheritance to extend both <a class="el" href="classcc__tools__qt_1_1Message.html" title="Main interface class used by CommsChampion Tools to display and manipulate messages.">cc_tools_qt::Message</a> and provided custom protocol message interface class (<b>demo::DemoMessage</b>). When extending provided interface class, additional options are passed to it to allow full available polymorphic interface (read, write, length retrieval, validity check, etc...). The <a class="el" href="classcc__tools__qt_1_1Message.html" title="Main interface class used by CommsChampion Tools to display and manipulate messages.">cc_tools_qt::Message</a> is the main interface class used by the <b>CommsChampion Tools</b> to manipulate messages.</p>
<p>The class hierarchy will look like this: </p><div class="diagraph">
<img src="dia_plugin_heirarchy.png" />
</div>
<p>The <a class="el" href="classcc__tools__qt_1_1Message.html" title="Main interface class used by CommsChampion Tools to display and manipulate messages.">cc_tools_qt::Message</a> interface class has multiple pure virtual functions, many of them are implemented inside <a class="el" href="classcc__tools__qt_1_1MessageBase.html" title="Helper class used to define protocol message interface class in CommsChampion Tools plugin environmen...">cc_tools_qt::MessageBase</a>. One of them is <a class="el" href="classcc__tools__qt_1_1Message.html#a0846a624e70620d0a500096ce1f60580" title="Polymophic functionality to get string representation of message ID.">cc_tools_qt::Message::idAsStringImpl()</a>. It is used to convert the message numeric ID into string representation to display it to user. The default implementation inside <a class="el" href="classcc__tools__qt_1_1MessageBase.html" title="Helper class used to define protocol message interface class in CommsChampion Tools plugin environmen...">cc_tools_qt::MessageBase</a> will convert it as is. However, it is recommended to override this function and provide better formatting. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>cc_plugin</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>DemoMessage : <span class="keyword">public</span> <a class="code hl_class" href="classcc__tools__qt_1_1MessageBase.html">cc_tools_qt::MessageBase</a>&lt;demo::DemoMessage&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">    <span class="keyword">virtual</span> QString idAsStringImpl()<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="comment">// uses getId() inherited from demo::DemoMessage</span></div>
<div class="line">        <span class="keywordflow">return</span> QString(<span class="stringliteral">&quot;0x%1&quot;</span>).arg(getId(), 2, 16, QChar(<span class="charliteral">&#39;0&#39;</span>));</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace cc_plugin</span></div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace demo</span></div>
</div><!-- fragment --><p>Please note, that there are two polymorphic interface classes: <a class="el" href="classcc__tools__qt_1_1Message.html" title="Main interface class used by CommsChampion Tools to display and manipulate messages.">cc_tools_qt::Message</a> and <b>comms::Message</b> (or <b>demo::DemoMessage</b>). The latter defines its virtual functions, which are implemented as part of protocol message definition (using <b>comms::MessageBase</b>). The <a class="el" href="classcc__tools__qt_1_1Message.html" title="Main interface class used by CommsChampion Tools to display and manipulate messages.">cc_tools_qt::Message</a> is used only by <b>CommsChampion Tools</b> and defines its own (pure) virtual functions which are expected to be overridden by the message implementation class. One of them is message name retrieval. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacecc__tools__qt.html">cc_tools_qt</a></div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>Message</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">protected:</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code hl_function" href="classcc__tools__qt_1_1Message.html#affb78492ae9a11ab333d50d271fc9161">nameImpl</a>() <span class="keyword">const</span> = 0;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// namespace cc_tools_qt</span></div>
<div class="ttc" id="aclasscc__tools__qt_1_1Message_html_affb78492ae9a11ab333d50d271fc9161"><div class="ttname"><a href="classcc__tools__qt_1_1Message.html#affb78492ae9a11ab333d50d271fc9161">cc_tools_qt::Message::nameImpl</a></div><div class="ttdeci">virtual const char * nameImpl() const =0</div><div class="ttdoc">Polymorphic name retrieval functionality.</div></div>
<div class="ttc" id="anamespacecc__tools__qt_html"><div class="ttname"><a href="namespacecc__tools__qt.html">cc_tools_qt</a></div><div class="ttdoc">Main namespace for all classes / functions of the shared library.</div></div>
</div><!-- fragment --><p>In order to be able to instantiate message object this pure virtual function needs to be implemented. In order to do this, there is a need to extend the existing implementation of the defined protocol message and implement missing function. Let's take <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/include/demo/message/IntValues.h">IntValues.h</a> and <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/cc_plugin/message/IntValues.h">cc_plugin/message/IntValues.h</a> as an example. The latter is implemented in the following way: </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"><span class="keyword">namespace </span>cc_plugin</div>
<div class="line">{</div>
<div class="line"><span class="keyword">namespace </span>message</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>IntValues : <span class="keyword">public</span> </div>
<div class="line">    <a class="code hl_class" href="classcc__tools__qt_1_1ProtocolMessageBase.html">cc_tools_qt::ProtocolMessageBase</a>&lt;</div>
<div class="line">        demo::message::IntValues&lt;demo::cc_plugin::DemoMessage&gt;,</div>
<div class="line">        IntValues</div>
<div class="line">    &gt;</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">protected:</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* nameImpl()<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keywordflow">return</span> <span class="stringliteral">&quot;IntValues&quot;</span>;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line">} <span class="comment">// namespace message</span></div>
<div class="line">} <span class="comment">// namespace cc_plugin</span></div>
<div class="line">} <span class="comment">// namespace demo</span></div>
<div class="ttc" id="aclasscc__tools__qt_1_1ProtocolMessageBase_html"><div class="ttname"><a href="classcc__tools__qt_1_1ProtocolMessageBase.html">cc_tools_qt::ProtocolMessageBase</a></div><div class="ttdoc">Helper class used to implement several pure virtual functions defined in cc_tools_qt::Message interfa...</div><div class="ttdef"><b>Definition</b> ProtocolMessageBase.h:44</div></div>
</div><!-- fragment --><p> Please note that the class inherits from <a class="el" href="classcc__tools__qt_1_1ProtocolMessageBase.html" title="Helper class used to implement several pure virtual functions defined in cc_tools_qt::Message interfa...">cc_tools_qt::ProtocolMessageBase</a>, which overrides and implements two pure virtual functions defined by <a class="el" href="classcc__tools__qt_1_1Message.html" title="Main interface class used by CommsChampion Tools to display and manipulate messages.">cc_tools_qt::Message</a>: </p><ul>
<li><a class="el" href="classcc__tools__qt_1_1Message.html#ad078bdf3261ada5bd998ef56c8e67dc1" title="Polymophic assignment functionality.">cc_tools_qt::Message::assignImpl()</a> </li>
<li><a class="el" href="classcc__tools__qt_1_1Message.html#ae4da273abef9c20d0e8bac3d689670f4" title="Polymorphic reset functionality.">cc_tools_qt::Message::resetImpl()</a></li>
</ul>
<p>Also note, that <a class="el" href="classcc__tools__qt_1_1ProtocolMessageBase.html" title="Helper class used to implement several pure virtual functions defined in cc_tools_qt::Message interfa...">cc_tools_qt::ProtocolMessageBase</a> class receives two template parameters. The first one is the protocol message class the <a class="el" href="classcc__tools__qt_1_1ProtocolMessageBase.html" title="Helper class used to implement several pure virtual functions defined in cc_tools_qt::Message interfa...">cc_tools_qt::ProtocolMessageBase</a> will inherit from (<b>demo::message::IntValues&lt;demo::cc_plugin::DemoMessage&gt;</b>). The second one is the type of the message class itself (<b>IntValues</b>).</p>
<p>One more thing to note, is the previously defined <b>demo::cc_plugin::DemoMessage</b> is passed as interface class to <b>demo::message::IntValues</b> (as a template parameter).</p>
<p>The full inheritence hierarchy will look like this: </p><div class="diagraph">
<img src="dia_plugin_full_heirarchy.png" />
</div>
<h1><a class="anchor" id="page_protocol_plugin_fields_properties"></a>
Fields and Their Properties</h1>
<p>The <b>CommsChampion Tools</b> are there to help visualise and debug custom binary protocols. The definition of the messages using <b>COMMS</b> library is used to define serialisation and deserialisation of the protocol messages. However, such definitions do not contain any extra information on how the message fields need to be displayed. For example, when displaying a value of <b>comms::field::EnumValue</b> field, there is a need to display a human readable "name" of the value in addition to its serialised raw bytes.</p>
<p><img src="image/enum_value_field.png" alt="" class="inline"/></p>
<p>In order to provide the required information, the message definition class for the protocol plugin (<b>demo::cc_plugin::IntValues</b>) is expected to override inherited <a class="el" href="classcc__tools__qt_1_1Message.html#abad8fba8f55acc1ee18f226aa4d617ff" title="Polymorphic fields properties retrieval function.">cc_tools_qt::Message::fieldsPropertiesImpl()</a> and provide the required properties of the fields. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"><span class="keyword">namespace </span>cc_plugin</div>
<div class="line">{</div>
<div class="line"><span class="keyword">namespace </span>message</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>IntValues : <span class="keyword">public</span> </div>
<div class="line">    <a class="code hl_class" href="classcc__tools__qt_1_1ProtocolMessageBase.html">cc_tools_qt::ProtocolMessageBase</a>&lt;</div>
<div class="line">        demo::message::IntValues&lt;demo::cc_plugin::DemoMessage&gt;,</div>
<div class="line">        IntValues</div>
<div class="line">    &gt;</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">protected:</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> QVariantList&amp; fieldsPropertiesImpl()<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> QVariantList Props = createFieldsProperties(); <span class="comment">// defined in anonymous namespace</span></div>
<div class="line">        <span class="keywordflow">return</span> Props;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line">} <span class="comment">// namespace message</span></div>
<div class="line">} <span class="comment">// namespace cc_plugin</span></div>
<div class="line">} <span class="comment">// namespace demo</span></div>
</div><!-- fragment --><p> <b>NOTE</b>, that the properties are defined as <code>static const</code> variable and created only once upon first entry. The field's properties are the description on the way how the fields need to be displayed and do not depend on the field's value.</p>
<p>Also note, that the properties are stored in QVariantList, size of which must be equal to number of fields, the message contains. </p><div class="fragment"><div class="line"><span class="keyword">namespace</span></div>
<div class="line">{</div>
<div class="line">QVariantList createFieldsProperties()</div>
<div class="line">{</div>
<div class="line">    QVariantList props;</div>
<div class="line">    props.append(...<span class="comment">/* properties of field1 */</span>);</div>
<div class="line">    props.append(...<span class="comment">/* properties of field2 */</span>);</div>
<div class="line">    ...</div>
<div class="line"> </div>
<div class="line">    assert(props.size() == IntValues::FieldIdx_numOfValues);</div>
<div class="line">    <span class="keywordflow">return</span> props;</div>
<div class="line">}</div>
<div class="line">} <span class="comment">// namespace</span></div>
</div><!-- fragment --><p>One more thing to note is that set of properties for a single field are stored in <b>QVariantMap</b>. However, it is implicitly converted to <b>QVariant</b> when inserted into the <b>QVariantList</b>.</p>
<p>If the message doesn't have any fields, there is no need to override <a class="el" href="classcc__tools__qt_1_1Message.html#abad8fba8f55acc1ee18f226aa4d617ff" title="Polymorphic fields properties retrieval function.">cc_tools_qt::Message::fieldsPropertiesImpl()</a>. The <a class="el" href="classcc__tools__qt_1_1Message.html" title="Main interface class used by CommsChampion Tools to display and manipulate messages.">cc_tools_qt::Message</a> class itself provides default implementation which returns empty list.</p>
<p>The helper classes that allow definition of the fields' properties reside in <a class="el" href="namespacecc__tools__qt_1_1property_1_1field.html" title="Namespace containing classes describing various properties of fields from COMMS library.">cc_tools_qt::property::field</a> namespace, please refer to <a class="el" href="page_fields_properties.html">Defining Fields' Properties</a> separate tutorial page for details on how to use them.</p>
<h1><a class="anchor" id="page_protocol_plugin_all_messages"></a>
All Messages</h1>
<p>Afther all the message classes for the protocol plagin were defined, they need to be bundled into <b>std::tuple</b> (see <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/cc_plugin/AllMessages.h">cc_plugin/AllMessages.h</a>). </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>cc_plugin</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using </span>AllMessages = std::tuple&lt;</div>
<div class="line">    cc_plugin::message::IntValues,</div>
<div class="line">    cc_plugin::message::EnumValues,</div>
<div class="line">    cc_plugin::message::BitmaskValues,</div>
<div class="line">    cc_plugin::message::Bitfields,</div>
<div class="line">    cc_plugin::message::Strings,</div>
<div class="line">    cc_plugin::message::Lists,</div>
<div class="line">    cc_plugin::message::Optionals,</div>
<div class="line">    cc_plugin::message::FloatValues,</div>
<div class="line">    cc_plugin::message::Variants</div>
<div class="line">&gt;;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static_assert</span>(std::tuple_size&lt;AllMessages&gt;::value == MsgId_NumOfValues,</div>
<div class="line">    <span class="stringliteral">&quot;Some messages are missing&quot;</span>);</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace cc_plugin</span></div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace demo</span></div>
</div><!-- fragment --><h1><a class="anchor" id="page_protocol_plugin_stack"></a>
Protocol Stack</h1>
<p>The <a class="el" href="page_protocol_plugin.html#page_protocol_plugin_protocol_def">Protocol Definition</a> section above defined how protocol stack should be defined when implementing common protocol definition. Usage of the template parameters leaves us space to redefine it for <b>CommsChampion Tools</b> plugin environment (see <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/cc_plugin/DemoStack.h">cc_plugin/DemoStack.h</a>). </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>cc_plugin</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">using </span>DemoStack = demo::Stack&lt;</div>
<div class="line">    cc_plugin::Message,</div>
<div class="line">    cc_plugin::AllMessages</div>
<div class="line">&gt;;</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace cc_plugin</span></div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace demo</span></div>
</div><!-- fragment --><p> NOTE, that the passed first template parameter is the common interface class for all the message classes in the plugin environment (defined in the <a class="el" href="page_protocol_plugin.html#page_protocol_plugin_message">Messages in Plugin Environment</a> section), and the second template parameter is the messages themselves.</p>
<h1><a class="anchor" id="page_protocol_plugin_transport_message"></a>
Transport Message</h1>
<p>In order to understand what the "Transport Message" is, let's take a look how the <b>cc_view</b> (main GUI application of the <b>CommsChampion Tools</b>) displays a message. The bottom right area allows to request a display of "Transport" information instead of message itself with its fields.</p>
<p><img src="image/protocol_stack_transport.png" alt="" class="inline"/></p>
<p>When clicked it displays the transport information instead of application message.</p>
<p><img src="image/protocol_stack_transport_msg.png" alt="" class="inline"/></p>
<p>The displayed transport information is presented like any other message, but with fields difined by the "protocol stack".</p>
<p>In order to support displaying of the transport information for the newly developed protocol plugin, there is a need to create a dummy message, which will contain all the fields defined by the protocol stack. Please see the <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/cc_plugin/DemoTransportMessage.h">cc_plugin/DemoTransportMessage.h</a> and <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/cc_plugin/DemoTransportMessage.cpp">cc_plugin/DemoTransportMessage.cpp</a> as an example. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>cc_plugin</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>DemoTransportMessage : <span class="keyword">public</span></div>
<div class="line">    <a class="code hl_class" href="classcc__tools__qt_1_1TransportMessageBase.html">cc_tools_qt::TransportMessageBase</a>&lt;</div>
<div class="line">        cc_plugin::Message,</div>
<div class="line">        std::tuple&lt;</div>
<div class="line">            demo::SyncField,</div>
<div class="line">            demo::LengthField,</div>
<div class="line">            demo::MsgIdField,</div>
<div class="line">            demo::DataField&lt;&gt;,</div>
<div class="line">            demo::ChecksumField</div>
<div class="line">        &gt;</div>
<div class="line">    &gt;</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace cc_plugin</span></div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace demo</span></div>
<div class="ttc" id="aclasscc__tools__qt_1_1TransportMessageBase_html"><div class="ttname"><a href="classcc__tools__qt_1_1TransportMessageBase.html">cc_tools_qt::TransportMessageBase</a></div><div class="ttdoc">Base class for TransportMessage definition in protocol plugin.</div><div class="ttdef"><b>Definition</b> TransportMessageBase.h:60</div></div>
</div><!-- fragment --><p> Note, that the <b>demo::cc_plugin::DemoTransportMessage</b> class inherits from <a class="el" href="classcc__tools__qt_1_1TransportMessageBase.html" title="Base class for TransportMessage definition in protocol plugin.">cc_tools_qt::TransportMessageBase</a> providing two template parameters. The first one is common message interface class (<b>demo::cc_plugin::Message</b>) defined in <a class="el" href="page_protocol_plugin.html#page_protocol_plugin_message">Messages in Plugin Environment</a> section. The second parameter is <b>std::tuple</b> of all the fields used to defined "protocol stack", but appearing <b>in order of their serialisation</b>.</p>
<p>The "protocol stack" defines its internal type <b>AllFields</b>, which contains all the "transport" fields <b>in order of their appearance in protocol stack definition</b>. If order of fields' <b>serialisation</b> is the same as order of fields' appearance in protocol stack, the <b>AllFields</b> internal type could be reused. However, this is not the case for <b>demo</b> protocol. The latter defines its protocol stack in the following way: </p><div class="diagraph">
<img src="dia_demo_protocol_stack.png" />
</div>
<p> The <b>CHECKSUM</b> layer wraps the <b>LENGTH</b>. As the result the fields are defined in the following order. </p><div class="fragment"><div class="line">std::tuple&lt;</div>
<div class="line">    demo::SyncField,</div>
<div class="line">    demo::ChecksumField, <span class="comment">// &lt;--- The checksum is here</span></div>
<div class="line">    demo::LengthField,</div>
<div class="line">    demo::MsgIdField,</div>
<div class="line">    demo::DataField&lt;&gt;</div>
<div class="line">&gt;</div>
</div><!-- fragment --><p> In case of direct reusing of <b>demo::Stack::AllFields</b> the transport information would be displayed incorrectly.</p>
<p>The <b>DemoTransportMessage</b> is a descendent of common message interface class defined for the plugin (<b>demo::cc_plugin::DemoMessage</b>) and is expected to provide properties of its fields. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>cc_plugin</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>DemoTransportMessage : <span class="keyword">public</span></div>
<div class="line">    <a class="code hl_class" href="classcc__tools__qt_1_1TransportMessageBase.html">cc_tools_qt::TransportMessageBase</a>&lt;...&gt;</div>
<div class="line">{</div>
<div class="line">    ...</div>
<div class="line">protected:</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> QVariantList&amp; fieldsPropertiesImpl() <span class="keyword">const override</span>;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace cc_plugin</span></div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace demo</span></div>
</div><!-- fragment --><p> The <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/cc_plugin/DemoTransportMessage.cpp">cc_plugin/DemoTransportMessage.cpp</a> file contains code of this function. Please refer to <a class="el" href="page_fields_properties.html">Defining Fields' Properties</a> tutorial page to learn how to set field's properties.</p>
<p>the <b>TransportMessage</b> is also a descendent of common message interface class defined as part of the protocol definition (<b>demo::DemoMessage</b>). One of the base classes up the inheritance chain provides default implementation of <b>comms::Message::readImpl()</b> virtual function. However, in case of the <b>demo</b> protocol, the default implementation is incorrect. An attempt to deserialise such message will fail. This is because the <b>PAYLOAD</b> field doesn't have any length limitation and will consume all input without leaving anything to the <b>CHECKSUM</b> value. In order to fix it the implementation of <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/cc_plugin/DemoTransportMessage.h">demo::cc_plugin::DemoTransportMessage</a> needs to override it and provide correct implementation. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>cc_plugin</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>DemoTransportMessage : <span class="keyword">public</span></div>
<div class="line">    <a class="code hl_class" href="classcc__tools__qt_1_1TransportMessageBase.html">cc_tools_qt::TransportMessageBase</a>&lt;...&gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    <span class="keyword">enum</span> FieldIdx</div>
<div class="line">    {</div>
<div class="line">        FieldIdx_Sync,</div>
<div class="line">        FieldIdx_Len,</div>
<div class="line">        FieldIdx_Id,</div>
<div class="line">        FieldIdx_Payload,</div>
<div class="line">        FieldIdx_Checksum,</div>
<div class="line">        FieldIdx_NumOfValues</div>
<div class="line">    };</div>
<div class="line">    ...</div>
<div class="line">protected:</div>
<div class="line">    <span class="keyword">virtual</span> comms::ErrorStatus readImpl(ReadIterator&amp; iter, std::size_t size)<span class="keyword"> override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">auto</span> ChecksumLen =</div>
<div class="line">            <span class="keyword">sizeof</span>(demo::ChecksumField::ValueType);</div>
<div class="line">    </div>
<div class="line">        size -= ChecksumLen;</div>
<div class="line">        <span class="keyword">auto</span> es = readFieldsUntil&lt;FieldIdx_Checksum&gt;(iter, size);</div>
<div class="line">        <span class="keywordflow">if</span> (es == comms::ErrorStatus::Success) {</div>
<div class="line">            size += ChecksumLen;</div>
<div class="line">            es = readFieldsFrom&lt;FieldIdx_Checksum&gt;(iter, size);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">return</span> es;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace cc_plugin</span></div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace demo</span></div>
</div><!-- fragment --><p> The <b>readFieldsUntil()</b> and <b>readFieldsFrom()</b> functions are provided by <b>comms::MessageBase</b> class, which is also one of the ancestors to the <b>TransportMessage</b> class.</p>
<h1><a class="anchor" id="page_protocol_plugin_protocol"></a>
Protocol Class</h1>
<p>The <b>CommsChampion Tools</b> use <a class="el" href="classcc__tools__qt_1_1Protocol.html" title="Main polymorphic interface class for protocols.">cc_tools_qt::Protocol</a> polymorphic interface class to create and update messages. It means that our <b>protocol</b> definition class needs to be a descendent of <a class="el" href="classcc__tools__qt_1_1Protocol.html" title="Main polymorphic interface class for protocols.">cc_tools_qt::Protocol</a>. The latter defines multiple pure virtual functions, which the derived class must implement. The <b><a class="el" href="namespacecc__tools__qt.html" title="Main namespace for all classes / functions of the shared library.">cc_tools_qt</a></b> library also provides <a class="el" href="classcc__tools__qt_1_1ProtocolBase.html" title="Helper class to define custom Protocol.">cc_tools_qt::ProtocolBase</a> template class, which inherits from <a class="el" href="classcc__tools__qt_1_1Protocol.html" title="Main polymorphic interface class for protocols.">cc_tools_qt::Protocol</a> and implements most of the required virtual functions using info from provided template parameters. Hence, the custom protocol definition class needs to inherit from <a class="el" href="classcc__tools__qt_1_1ProtocolBase.html" title="Helper class to define custom Protocol.">cc_tools_qt::ProtocolBase</a> and provide necessary info.</p>
<p>The <b>demo</b> protocol defines its <b>Protocol</b> class in <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/cc_plugin/DemoProtocol.h">cc_plugin/DemoProtocol.h</a> and <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/cc_plugin/DemoProtocol.cpp">cc_plugin/DemoProtocol.cpp</a> files. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>cc_plugin</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>DemoProtocol : <span class="keyword">public</span></div>
<div class="line">    <a class="code hl_class" href="classcc__tools__qt_1_1ProtocolBase.html">cc_tools_qt::ProtocolBase</a>&lt;</div>
<div class="line">        cc_plugin::DemoStack,</div>
<div class="line">        DemoTransportMessage</div>
<div class="line">    &gt;</div>
<div class="line">{</div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    DemoProtocol() = <span class="keywordflow">default</span>;</div>
<div class="line">    <span class="keyword">virtual</span> ~DemoProtocol();</div>
<div class="line"> </div>
<div class="line"><span class="keyword">protected</span>:</div>
<div class="line">    <span class="keyword">virtual</span> <span class="keyword">const</span> QString&amp; nameImpl()<span class="keyword"> const override</span></div>
<div class="line"><span class="keyword">    </span>{</div>
<div class="line">        <span class="keyword">static</span> <span class="keyword">const</span> QString&amp; Str(<span class="stringliteral">&quot;Demo&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> Str;</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace cc_plugin</span></div>
<div class="line"> </div>
<div class="line">}  <span class="comment">// namespace demo</span></div>
<div class="ttc" id="aclasscc__tools__qt_1_1ProtocolBase_html"><div class="ttname"><a href="classcc__tools__qt_1_1ProtocolBase.html">cc_tools_qt::ProtocolBase</a></div><div class="ttdoc">Helper class to define custom Protocol.</div><div class="ttdef"><b>Definition</b> ProtocolBase.h:57</div></div>
</div><!-- fragment --><p> Please note the following: </p><ul>
<li>The first template parameter to <a class="el" href="classcc__tools__qt_1_1ProtocolBase.html" title="Helper class to define custom Protocol.">cc_tools_qt::ProtocolBase</a> class is a definition of the "protocol stack" (see <a class="el" href="page_protocol_plugin.html#page_protocol_plugin_stack">Protocol Stack</a>), which handles all the transport data. </li>
<li>The second template parameter to <a class="el" href="classcc__tools__qt_1_1Protocol.html" title="Main polymorphic interface class for protocols.">cc_tools_qt::Protocol</a> class is a definition of the "transport message", i.e the one difined in <a class="el" href="page_protocol_plugin.html#page_protocol_plugin_transport_message">Transport Message</a> section. </li>
<li>The only pure virtual function defined by <a class="el" href="classcc__tools__qt_1_1Protocol.html" title="Main polymorphic interface class for protocols.">cc_tools_qt::Protocol</a> and not implemented in <a class="el" href="classcc__tools__qt_1_1ProtocolBase.html" title="Helper class to define custom Protocol.">cc_tools_qt::ProtocolBase</a> is <a class="el" href="classcc__tools__qt_1_1Protocol.html#afda5654996ab6c568156fb5539d78c8b" title="Polymorphic protocol name retrieval.">cc_tools_qt::Protocol::nameImpl()</a>, i.e. the one that provides name of the protocol. The defined protocol class must override and implement it.</li>
</ul>
<h1><a class="anchor" id="page_protocol_plugin_plugin_class"></a>
Plugin Class</h1>
<p>The final thing to do is to define the actual plugin class. Please read the <a class="el" href="page_plugin.html">Defining a Plugin</a> page first to understand the way the plugins are defined.</p>
<p>The <b>demo</b> protocol defines its <b>Plugin</b> class in <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/cc_plugin/DemoProtocol.h">cc_plugin/DemoPlugin.h</a> and <a href="https://github.com/commschamp/cc_tools_qt/blob/master/demo/cc_plugin/DemoProtocol.cpp">cc_plugin/DemoPlugin.cpp</a> files. </p><div class="fragment"><div class="line"><span class="keyword">namespace </span>demo</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>cc_plugin</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>DemoPlugin : <span class="keyword">public</span> <a class="code hl_class" href="classcc__tools__qt_1_1Plugin.html">cc_tools_qt::Plugin</a></div>
<div class="line">{</div>
<div class="line">    Q_OBJECT</div>
<div class="line">    Q_PLUGIN_METADATA(IID <span class="stringliteral">&quot;cc.DemoProtocol&quot;</span> FILE <span class="stringliteral">&quot;demo.json&quot;</span>)</div>
<div class="line">    Q_INTERFACES(<a class="code hl_class" href="classcc__tools__qt_1_1Plugin.html">cc_tools_qt::Plugin</a>)</div>
<div class="line"> </div>
<div class="line"><span class="keyword">public</span>:</div>
<div class="line">    Plugin()</div>
<div class="line">    {</div>
<div class="line">        pluginProperties()</div>
<div class="line">            .setProtocolCreateFunc(</div>
<div class="line">                [<span class="keyword">this</span>]()</div>
<div class="line">                {</div>
<div class="line">                    <span class="comment">// allocates previously defined demo::cc_plugin::Protocol</span></div>
<div class="line">                    <span class="keywordflow">return</span> <a class="code hl_typedef" href="namespacecc__tools__qt.html#a3f93a2ad75fdafbad184ac48706d85aa">cc_tools_qt::ProtocolPtr</a>(<span class="keyword">new</span> Protocol());</div>
<div class="line">                });</div>
<div class="line">    }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">} <span class="comment">// namespace cc_plugin</span></div>
<div class="line"> </div>
<div class="line">} <span class="comment">// namespace demo</span></div>
<div class="ttc" id="aclasscc__tools__qt_1_1Plugin_html"><div class="ttname"><a href="classcc__tools__qt_1_1Plugin.html">cc_tools_qt::Plugin</a></div><div class="ttdoc">Interface class for plugin definition.</div><div class="ttdef"><b>Definition</b> Plugin.h:39</div></div>
<div class="ttc" id="anamespacecc__tools__qt_html_a3f93a2ad75fdafbad184ac48706d85aa"><div class="ttname"><a href="namespacecc__tools__qt.html#a3f93a2ad75fdafbad184ac48706d85aa">cc_tools_qt::ProtocolPtr</a></div><div class="ttdeci">std::shared_ptr&lt; Protocol &gt; ProtocolPtr</div><div class="ttdoc">Pointer to Protocol object.</div><div class="ttdef"><b>Definition</b> Protocol.h:293</div></div>
</div><!-- fragment --><p> If the protocol requires configuration, please also provide a callback which creates the widget when invoked (see <a class="el" href="page_plugin.html#page_plugin_properties_config_widget">Configuration Widget</a>). </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
